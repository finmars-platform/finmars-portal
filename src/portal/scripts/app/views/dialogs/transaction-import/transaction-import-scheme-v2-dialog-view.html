<md-dialog aria-label="import transaction scheme v2 manager dialog"
           class="transaction-scheme-manager-dialog-view transaction-scheme-manager-dialog-view-v2 dialog-actions-bottom"
>
    <md-toolbar>
        <div class="md-toolbar-tools position-relative">
            <h2>{{ vm.editingScheme ? 'Edit' : 'Create' }} Transaction scheme (v2)</h2>
            <div data-ng-if="vm.processing" layout="row" class="m-l-16">
                <div layout="row" layout-sm="column" layout-align="space-around" class="m-r-8">
                    <progress-circular data-diameter="10"></progress-circular>
                </div>
                â€” Processing
            </div>

            <draft-button data-ng-if="vm.draftUserCode"
                          data-user-code="vm.draftUserCode"
                          data-on-export-to-draft-callback="vm.exportToDraft($event)"
                          data-on-draft-apply-callback="vm.applyDraft(event, data)"></draft-button>
        </div>
    </md-toolbar>

    <md-dialog-content>
        <md-content class="height-100">
            <div data-ng-if="vm.checkReadyStatus()" class="height-100">

                <md-tabs class="height-100">
                    <md-tab>
                        <md-tab-label>General</md-tab-label>

                        <md-tab-body>

                            <div layout="row" layout-align="center center">
                                <md-card flex="100" class="inm-card-special">
                                    <md-card-content layout="column">

                                        <!--<usercode-input data-item="vm.scheme"></usercode-input>-->
                                        <usercode-input data-user-code="vm.scheme.user_code"
                                                        data-is-disabled="vm.editingScheme"
                                                        data-on-configuration-code-change-callback="vm.onConfigCodeChange(changedValue)"
                                        ></usercode-input>

                                        <md-input-container class="md-block">
                                            <label for="">Name</label>
                                            <input type="text" data-ng-model="vm.scheme.name">
                                        </md-input-container>
                                        <md-input-container class="md-block">
                                            <label for="">Short name</label>
                                            <input type="text" data-ng-model="vm.scheme.short_name">
                                        </md-input-container>
                                        <div layout="row">
                                            <md-input-container flex style="margin-bottom: 0">
                                                <label for="">Expression for Transaction Type Selector</label>
                                                <input type="text" data-ng-model="vm.scheme.rule_expr">
                                            </md-input-container>
                                            <expression-editor-button data-item="vm.scheme.rule_expr"
                                                                      data-data="vm.exprEditorBtnData"></expression-editor-button>

                                            <md-button class="md-raised md-primary"
                                                       data-ng-click="vm.openSelectorManager($event)"
                                                       style="min-height: 30px; height: 30px; line-height: 1;">
                                                Selector Values
                                            </md-button>
                                        </div>

                                        <div layout="row">
                                            <md-input-container flex style="margin-bottom: 0">
                                                <label for="">Expression for File Preprocessing</label>
                                                <input type="text" data-ng-model="vm.scheme.data_preprocess_expression">
                                            </md-input-container>
                                            <expression-editor-button data-item="vm.scheme.data_preprocess_expression"
                                                                      data-data="vm.exprEditorBtnData"></expression-editor-button>
                                        </div>

                                        <div layout="row">
                                            <md-input-container>
                                                <label for="">Error handling</label>
                                                <md-select data-ng-model="vm.scheme.error_handler">
                                                    <md-option value="continue">Continue</md-option>
                                                    <md-option value="break">Break on first error</md-option>
                                                </md-select>
                                            </md-input-container>

                                            <md-input-container>
                                                <label>Separator</label>
                                                <md-select data-ng-model="vm.scheme.delimiter">
                                                    <md-option value=",">Comma (,)</md-option>
                                                    <md-option value=";">Semicolon (;)</md-option>
                                                    <md-option value="\t">Tab</md-option>
                                                </md-select>
                                            </md-input-container>

                                            <md-input-container style="width: 245px;">
                                                <label>Import Rules - if object is not found</label>
                                                <md-select
                                                        data-ng-model="vm.scheme.missing_data_handler">
                                                    <md-option value="throw_error">Treat as Error</md-option>
                                                    <md-option value="set_defaults">Replace with Default Value
                                                    </md-option>
                                                </md-select>
                                            </md-input-container>

                                            <md-input-container class="md-block">
                                                <label for="">Spreadsheet start cell</label>
                                                <input type="text" data-ng-model="vm.scheme.spreadsheet_start_cell">
                                            </md-input-container>

                                            <md-input-container class="md-block">
                                                <label for="">Spreadsheet active tab</label>
                                                <input type="text"
                                                       data-ng-model="vm.scheme.spreadsheet_active_tab_name">
                                            </md-input-container>


                                        </div>

                                        <div layout="row">
                                            <md-input-container style="width: 245px;">
                                                <label>Column Matcher</label>
                                                <md-select
                                                        data-ng-model="vm.scheme.column_matcher">
                                                    <md-option value="index">Index</md-option>
                                                    <md-option value="name">Name</md-option>
                                                </md-select>
                                            </md-input-container>

                                            <md-input-container class="md-block">
                                                <md-checkbox ng-model="vm.scheme.has_header_row"
                                                             aria-label="">
                                                    Has header row
                                                </md-checkbox>
                                            </md-input-container>
                                        </div>
                                        <div>
                                            <md-input-container class="md-block">
                                                <label for="">Filter Expression</label>
                                                <input type="text" data-ng-model="vm.scheme.filter_expression">
                                            </md-input-container>
                                        </div>

                                        <div class="m-b-16">

                                            <md-input-container style="width: 260px;">
                                                <label>Transaction Unique Code Settings</label>
                                                <md-select
                                                        data-ng-model="vm.scheme.book_uniqueness_settings">
                                                    <md-option ng-value="1">Skip</md-option>
                                                    <md-option ng-value="2">Book without Unique Code
                                                    </md-option>
                                                    <md-option ng-value="3">Overwrite</md-option>
                                                    <md-option ng-value="4">Treat as error</md-option>
                                                </md-select>
                                            </md-input-container>

                                        </div>

                                        <div class="m-b-16">
                                            <md-input-container class="md-block">
                                                <label for="">Expression Iterations Count</label>
                                                <input type="number"
                                                       min="1"
                                                       data-ng-model="vm.scheme.expression_iterations_count">
                                            </md-input-container>
                                        </div>

                                    </md-card-content>
                                </md-card>
                            </div>

                        </md-tab-body>

                    </md-tab>

                    <md-tab>
                        <md-tab-label>Scheme</md-tab-label>

                        <md-tab-body>

                            <div class="scheme-tab-content"
                                 data-ng-class="{'show-dry-run': vm.showDryRun}">
                                <div>
                                    <md-button class="md-raised dry-run-button"
                                               data-ng-click="vm.showDryRun = !vm.showDryRun">
                                        <span data-ng-show="vm.showDryRun">Hide Dry Run</span>
                                        <span data-ng-show="!vm.showDryRun">Show Dry Run</span>
                                    </md-button>

                                    <div data-ng-if="vm.showDryRun">
                                        <div>

                                            <div layout="row">
                                            <textarea name="" id="" class="dry-run-data-textarea"
                                                      data-ng-model="vm.dryRunData"></textarea>
                                                <div layout="row">
                                                    <md-button class="md-raised dry-run-execute"
                                                               data-ng-click="vm.executeDryRun($event)">Execute
                                                    </md-button>
                                                    <div data-ng-if="vm.processing" style="padding-top: 12px">

                                                        <div layout="row" layout-sm="column" layout-align="space-around">
                                                            <progress-circular diameter="20"></progress-circular>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>


                                        </div>

                                        <div>

                                            <div data-ng-if="vm.dryRunResult.result" class="dry-run-result">

                                                <div>
                                                    Results:
                                                </div>

                                                <div data-ng-if="vm.dryRunResult.result.error_message">
                                                    <div class="error-color">{{vm.dryRunResult.result.error_message}}</div>
                                                </div>

                                                <md-card data-ng-repeat="item in vm.dryRunResult.result.items"
                                                         data-ng-click="vm.activateResultItem($event, item)"
                                                         class="dry-run-result-item {{item.active ? 'active' : ''}}">

                                                    <div
                                                            class="dry-run-result-item-body ">
                                                        <div>Line: {{item.row_number}}. Status: {{item.status}}</div>
                                                        <div class="dry-run-result-item-message">
                                                            {{item.message}}
                                                            <div style="color:red;">{{item.error_message}}</div>
                                                        </div>

                                                    </div>

                                                </md-card>


                                            </div>
                                            <div data-ng-if="!vm.dryRunResult.result">

                                                <div class="error-color">{{vm.dryRunResult.error_message}}</div>

                                            </div>


                                        </div>
                                    </div>
                                </div>

                                <div class="flex-row height-100 transaction-import-scheme-v2-cards-holder">

                                    <!-- Imported Columns-->
                                    <md-card class="flex-1-1-100 transaction-import-scheme-v2-file-inputs-holder schemeInputsScrollableElem">
                                        <md-card-content>

                                            <div class="transaction-import-scheme-v2-card-header">
                                                Imported Columns
                                                <input type="text" data-ng-model="vm.schemeInputsQuery"
                                                       placeholder="search..."
                                                       class="transaction-import-scheme-v2-card-header-search">
                                            </div>

                                            <div class="schemeInputsDragulaContainer" data-ng-init="vm.schemeInputsDragAndDrop.init()">
                                                <div data-ng-repeat="item in vm.schemeInputs | filter: vm.filterSchemeInputs as results track by item.frontOptions.key"
                                                     data-item-key="{{item.frontOptions.key}}"
                                                     class="transaction-import-scheme-v2-rows-container transaction-import-scheme-v2-file-input"
                                                >

                                                    <div class="top-left-drag-icon"
                                                         data-ng-mousedown="vm.turnOnDragging()">
                                                        <is-draggable-sign></is-draggable-sign>
                                                    </div>

                                                    <md-card class="row-card">
                                                        <!--<div>
                                                            <number-input data-model="item.column"
                                                                          data-small-options="vm.inputsOpts"></number-input>
                                                        </div>-->

                                                        <div class="transaction-import-scheme-input-container">
                                                            <text-input data-model="item.column_name"
                                                                        data-label="Column name"
                                                                        data-small-options="vm.inputsOpts"></text-input>
                                                        </div>

                                                        <div class="transaction-import-scheme-input-container">
                                                            <text-input data-model="item.name"
                                                                        data-label="name"
                                                                        data-small-options="vm.inputsOpts"
                                                                        data-on-blur-callback="vm.setSchemeInputExpression(item)"></text-input>
                                                        </div>

                                                        <div class="transaction-import-scheme-input-container">
                                                            <base-input data-indicator-button-icon="functions"
                                                                        data-model="item.name_expr"
                                                                        data-small-options="vm.exprInputOpts"
                                                                        data-ng-click="vm.openSchemeInputExpressionBuilder(item, $event)"
                                                                        class="import-scheme-calc-input-expr"
                                                            ></base-input>
                                                        </div>

                                                        <div class="p-l-8">
                                                            <md-button data-ng-click="vm.removeSchemeInput(item, $index)"
                                                                       class="action-btn m-0 outline-button">
                                                                <span class="material-icons">close</span>
                                                            </md-button>
                                                        </div>

                                                        <div data-ng-if="item.dryRunResult">

                                                            <span class="dry-run-result-value">{{item.dryRunResult}}</span>

                                                        </div>
                                                    </md-card>

                                                </div>
                                            </div>

                                            <div>
                                                <md-button class="md-raised" ng-click="vm.addSchemeInput()">
                                                    Add field
                                                </md-button>
                                            </div>
                                        </md-card-content>
                                    </md-card>

                                    <!-- Calculated Variables-->
                                    <md-card class="flex-1-1-100 transaction-import-scheme-v2-calculated-inputs-holder calculatedInputsScrollableElem">
                                        <md-card-content>

                                            <div class="transaction-import-scheme-v2-card-header">
                                                Calculated Variables
                                                <input type="text" data-ng-model="vm.calculatedInputsQuery"
                                                       placeholder="search..."
                                                       class="transaction-import-scheme-v2-card-header-search">
                                            </div>

                                            <div class="calculatedInputsDragulaContainer" data-ng-init="vm.calculatedInputsDragAndDrop.init()">
                                                <div data-ng-repeat="item in vm.calculatedInputs | filter: vm.filterCalculatedInputs as results track by item.frontOptions.key"
                                                     data-item-key="{{item.frontOptions.key}}"
                                                     class="transaction-import-scheme-v2-rows-container transaction-import-scheme-v2-calculated-input"
                                                >

                                                    <div class="top-left-drag-icon"
                                                         data-ng-mousedown="vm.turnOnDragging()">
                                                        <is-draggable-sign></is-draggable-sign>
                                                    </div>

                                                    <md-card class="row-card">

                                                        <div class="transaction-import-scheme-input-container">
                                                            <text-input data-model="item.name"
                                                                        data-label="Name"
                                                                        data-small-options="vm.inputsOpts"
                                                                        data-on-blur-callback="vm.onCalculatedInputNameBlur(item)"></text-input>
                                                        </div>

                                                        <div class="transaction-import-scheme-input-container">
                                                            <base-input data-indicator-button-icon="functions"
                                                                        data-is-readonly="true"
                                                                        data-model="item.name_expr"
                                                                        data-ng-click="vm.openCalcFieldFxBtnExprBuilder(item, $event)"
                                                                        data-small-options="vm.exprInputOpts"
                                                                        class="import-scheme-calc-input-expr"
                                                            ></base-input>

                                                            <md-tooltip
                                                                    data-ng-if="item.frontOptions && item.frontOptions.noNameExpr"
                                                                    data-md-direction="top"
                                                                    class="error-tooltip">
                                                                No expression defined for the calculated variable.
                                                            </md-tooltip>
                                                        </div>

                                                        <div class="p-l-8">
                                                            <md-button data-ng-click="vm.removeCalculatedInput($index)"
                                                                       class="action-btn m-0 outline-button">
                                                                <span class="material-icons">close</span>
                                                            </md-button>
                                                        </div>

                                                        <div data-ng-if="item.dryRunResult" class="p-l-8">

                                                            <span class="dry-run-result-value">{{item.dryRunResult}}</span>

                                                        </div>

                                                    </md-card>

                                                </div>
                                            </div>

                                            <div>
                                                <md-button class="md-raised" ng-click="vm.addCalculatedInput()">
                                                    Add field
                                                </md-button>
                                            </div>

                                        </md-card-content>

                                    </md-card>

                                    <!-- Scenarios-->
                                    <md-card class="flex-1-1-100 transaction-import-scheme-v2-scenarios-holder">
                                        <md-card-content class="instrument-scheme-fields-holder p-0">

                                            <div class="transaction-import-scheme-v2-card-header">
                                                Transaction Type Matching Scenarios
                                                <input type="text" data-ng-model="vm.ruleScenariosQuery"
                                                       placeholder="search..."
                                                       class="transaction-import-scheme-v2-card-header-search">
                                            </div>

                                            <div>
                                                <div data-ng-repeat="item in vm.ruleScenarios | filter: {$: vm.ruleScenariosQuery}"
                                                     class="transaction-import-scheme-v2-scenario"
                                                     data-ng-class="{'active': item.showInputs}">

                                                    <div class="scenario-row">
                                                        <div>
                                                            <!--<md-input-container>
                                                                <label for="">Scenario Name</label>
                                                                <input type="text"
                                                                       data-ng-model="item.name">
                                                            </md-input-container>-->
                                                            <text-input data-model="item.name"
                                                                        data-label="Scenario Name"
                                                                        data-small-options="vm.inputsOpts"></text-input>
                                                        </div>

                                                        <div>
                                                            <!--<md-input-container>
                                                                <label for="">Status</label>
                                                                <md-select data-ng-model="item.status">
                                                                    <md-option value="active">Active</md-option>
                                                                    <md-option value="skip">Skip</md-option>
                                                                </md-select>
                                                            </md-input-container>-->
                                                            <dropdown-select data-model="item.status"
                                                                             data-menu-options="vm.schenarioStatusOpts"
                                                                             data-label="Status"></dropdown-select>
                                                        </div>

                                                        <div>
                                                            <two-fields-multiselect
                                                                    ng-model="item.selector_values"
                                                                    data-title="Selector values"
                                                                    data-items="vm.selectorValuesOpts"
                                                                    data-model="item.selector_values"
                                                                    data-nothing-selected-text="[ ]"
                                                                    data-selected-items-indication="chips"
                                                                    data-name-property="value"
                                                                    data-small-options="vm.selectorValuesMultiselectOpts"
                                                                    class="table-filter-input-container">
                                                            </two-fields-multiselect>
                                                        </div>

                                                        <div>
                                                            <!--<md-input-container
                                                                    aria-label="select with filter">

                                                                <label for="">Transaction type</label>
                                                                <md-select ng-model="item.transaction_type"
                                                                           md-container-class="common-select-container"
                                                                           md-on-close="searchTerm = ''"
                                                                           ng-change="vm.onTransactionTypeChange(changedValue, item)"
                                                                           style="margin: 0;">

                                                                    <md-select-header>
                                                                        <input data-ng-model="searchTerm"
                                                                               type="search"
                                                                               placeholder="Search for a ..."
                                                                               class="md-text md-select-search-pattern select-input-filter"
                                                                               ng-keydown="$event.stopPropagation()">
                                                                    </md-select-header>

                                                                    <div class="select-options-holder">

                                                                        <md-option
                                                                                data-ng-repeat="transactionType in vm.transactionTypes | filter: {name: searchTerm}"
                                                                                ng-value="transactionType.user_code"

                                                                        >
                                                                            {{transactionType.name}}
                                                                            ({{transactionType.user_code}})
                                                                        </md-option>

                                                                    </div>

                                                                </md-select>
                                                            </md-input-container>-->
                                                            <dropdown-select data-model="item.transaction_type"
                                                                             data-menu-options="vm.transactionTypesOpts"
                                                                             data-label="Transaction type"
                                                                             data-on-change-callback="vm.onTransactionTypeChange(changedValue, item)"></dropdown-select>
                                                        </div>

                                                        <div class="flex-row flex-i-center p-l-4">
                                                            <md-button class="action-btn outline-button row-item-margins"
                                                                       data-ng-disable="!item.transaction_type"
                                                                       data-ng-click="item.showInputs = !item.showInputs">
                                                                <!--<ng-md-icon icon="view_list"
                                                                            size="14"></ng-md-icon>-->
                                                                <span class="material-icons">view_list</span>
                                                                <md-tooltip class="tooltip_1"
                                                                            data-md-direction="top">
                                                                    <span>{{item.showInputs ? 'Hide' : 'Show'}} Inputs</span>
                                                                </md-tooltip>
                                                            </md-button>

                                                            <md-button class="action-btn outline-button row-item-margins"
                                                                       data-ng-disabled="!item.transaction_type"
                                                                       data-ng-click="vm.editTransactionType(item.transaction_type_object.id, $event)">
                                                                <span class="material-icons">mode_edit</span>
                                                                <md-tooltip class="tooltip_1"
                                                                            data-md-direction="top">Edit transaction type</md-tooltip>
                                                            </md-button>

                                                            <md-button data-ng-if="!item.required"
                                                                       class="action-btn outline-button row-item-margins"
                                                                       data-ng-click="vm.removeRuleScenario(item, $index)">
                                                                <span class="material-icons">close</span>
                                                                <md-tooltip class="tooltip_1"
                                                                            data-md-direction="top">Delete Scenario</md-tooltip>
                                                            </md-button>
                                                        </div>
                                                    </div>

                                                    <div data-ng-if="item.error_message" class="row-error">
                                                        <span class="error-color">{{item.error_message}}</span>
                                                    </div>

                                                    <div data-ng-if="item.showInputs"
                                                         class="transaction-import-scheme-v2-scenario-inputs-holder">

                                                        <div data-ng-if="item.processing">
                                                            <div layout="row" layout-sm="column"
                                                                 layout-align="space-around" class="m-16">
                                                                <progress-circular data-diameter="30"></progress-circular>
                                                            </div>
                                                        </div>

                                                        <div data-ng-if="!item.processing">
                                                            <table class="transaction-import-scheme-v2-scenario-inputs-table">
                                                                <tr data-ng-repeat="ttypeInput in item.frontOptions.transactionTypeInputs"
                                                                    class="transaction-import-scheme-v2-scenario-inputs">
                                                                    <td>
                                                                        <div class="transaction-import-scheme-v2-scenario-inputs-input-name">
                                                                            <span data-ng-bind="ttypeInput.verbose_name"></span>
                                                                            <div style="white-space: nowrap;">Input:
                                                                                <b><span
                                                                                        data-ng-bind="ttypeInput.name"></span></b>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div layout="row"
                                                                             class="transaction-import-scheme-v2-scenario-inputs-input-expressio">
                                                                            <div>
                                                                                <md-input-container>
                                                                                    <label for=""
                                                                                           data-ng-bind="vm.bindType(ttypeInput)"></label>
                                                                                    <input type="text"
                                                                                           data-ng-model="ttypeInput.expression">
                                                                                </md-input-container>
                                                                            </div>
                                                                            <div>
                                                                                <expression-editor-button
                                                                                        data-item="ttypeInput.expression"
                                                                                        data-data="{groups: [vm.inputsGroup], functions: [vm.inputsFunctions]}"></expression-editor-button>
                                                                            </div>


                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div data-ng-if="ttypeInput.dryRunResult">

                                                                            <span class="dry-run-result-value">{{ttypeInput.dryRunResult}}</span>

                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>

                                            <div layout="row">
                                                <md-button class="md-raised"
                                                           data-ng-click="vm.addRuleScenario()">Add scenario</md-button>
                                            </div>

                                            <h4>Default Rule Scenario</h4>

                                            <div>

                                                <div class="flex-row flex-i-center width-100">

                                                    <div class="row-item-margins" style="flex: 0 0 100px;">
                                                        <text-input data-model="vm.defaultRuleScenario.name"
                                                                    data-label="Scenario Name"
                                                                    data-small-options="vm.ruleScenarioInputsOpts"></text-input>
                                                    </div>

                                                    <div class="row-item-margins" style="flex: 0 0 200px">
                                                        <!--<md-input-container style="width: 80%"
                                                                            aria-label="select with filter">

                                                            <label for="">Transaction type</label>
                                                            <md-select
                                                                    ng-model="vm.defaultRuleScenario.transaction_type"
                                                                    ng-change="vm.onTransactionTypeChange(vm.defaultRuleScenario)"
                                                                    md-container-class="common-select-container"
                                                                    md-on-close="searchTerm = ''"
                                                                    style="margin: 0;">

                                                                <md-select-header>
                                                                    <input data-ng-model="searchTerm"
                                                                           type="search"
                                                                           placeholder="Search for a ..."
                                                                           class="md-text md-select-search-pattern select-input-filter"
                                                                           ng-keydown="$event.stopPropagation()">
                                                                </md-select-header>

                                                                <div class="select-options-holder">

                                                                    <md-option
                                                                            data-ng-repeat="transactionType in vm.transactionTypes | filter: {name: searchTerm}"
                                                                            ng-value="transactionType.user_code"
                                                                    >
                                                                        {{transactionType.name}}
                                                                        ({{transactionType.user_code}})
                                                                    </md-option>

                                                                </div>

                                                            </md-select>
                                                        </md-input-container>-->
                                                        <dropdown-select data-label="Transaction type"
                                                                         data-model="vm.defaultRuleScenario.transaction_type"
                                                                         data-menu-options="vm.transactionTypesOpts"
                                                                         data-on-change-callback="vm.onTransactionTypeChange(changedValue, vm.defaultRuleScenario)"></dropdown-select>
                                                    </div>

                                                    <div class="flex-row flex-i-center p-l-4">

                                                        <md-button class="outline-button row-item-margins action-btn"
                                                                   data-ng-disabled="!vm.defaultRuleScenario.transaction_type"
                                                                   data-ng-click="vm.defaultRuleScenario.showInputs = !vm.defaultRuleScenario.showInputs">
                                                            <span class="material-icons">view_list</span>

                                                            <md-tooltip class="tooltip_1"
                                                                        data-md-direction="top">
                                                                <span>{{vm.defaultRuleScenario.showInputs ? 'Hide' : 'Show'}} Inputs</span>
                                                            </md-tooltip>
                                                        </md-button>

                                                        <md-button class="outline-button row-item-margins action-btn"
                                                                   data-ng-disabled="!vm.defaultRuleScenario.transaction_type"
                                                                   data-ng-click="vm.editTransactionType(vm.defaultRuleScenario.transaction_type_object.id, $event)">
                                                            <span class="material-icons">mode_edit</span>
                                                            <md-tooltip class="tooltip_1"
                                                                        data-md-direction="top">Edit transaction type</md-tooltip>
                                                        </md-button>

                                                    </div>
                                                </div>

                                                <div data-ng-if="vm.defaultRuleScenario.error_message" class="row-error">
                                                    <span class="error-color">{{vm.defaultRuleScenario.error_message}}</span>
                                                </div>

                                                <div data-ng-if="vm.defaultRuleScenario.showInputs"
                                                     class="transaction-import-scheme-v2-scenario-inputs-holder">

                                                    <div data-ng-if="vm.defaultRuleScenario.frontOptions.processing">
                                                        <div layout="row" layout-sm="column"
                                                             layout-align="space-around" class="m-16">
                                                            <progress-circular diameter="30"></progress-circular>
                                                        </div>
                                                    </div>

                                                    <div data-ng-if="!vm.defaultRuleScenario.frontOptions.processing">
                                                        <table class="transaction-import-scheme-v2-scenario-inputs-table">
                                                            <tr data-ng-repeat="input_item in vm.defaultRuleScenario.frontOptions.transactionTypeInputs"
                                                                class="transaction-import-scheme-v2-scenario-inputs">
                                                                <td>
                                                                    <div class="transaction-import-scheme-v2-scenario-inputs-input-name">
                                                                        <span data-ng-bind="input_item.verbose_name"></span>
                                                                        <div style="white-space: nowrap;">Input:
                                                                            <b><span
                                                                                    data-ng-bind="input_item.name"></span></b>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div layout="row"
                                                                         class="transaction-import-scheme-v2-scenario-inputs-input-expressio">
                                                                        <div>
                                                                            <md-input-container>
                                                                                <label for=""
                                                                                       data-ng-bind="vm.bindType(input_item)"></label>
                                                                                <input type="text"
                                                                                       data-ng-model="input_item.expression">
                                                                            </md-input-container>
                                                                        </div>
                                                                        <div>
                                                                            <expression-editor-button
                                                                                    data-item="input_item.expression"
                                                                                    data-data="{groups: [vm.inputsGroup], functions: [vm.inputsFunctions]}"></expression-editor-button>
                                                                        </div>


                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div data-ng-if="input_item.dryRunResult">

                                                                        <span class="dry-run-result-value">{{input_item.dryRunResult}}</span>

                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </div>

                                            </div>

                                            <h4>Error Rule Scenario</h4>

                                            <div>

                                                <div class="flex-row flex-i-center width-100">

                                                    <div class="row-item-margins"
                                                         style="flex: 0 0 100px;">
                                                        <text-input data-model="vm.errorRuleScenario.name"
                                                                    data-label="Scenario Name"
                                                                    data-small-options="vm.ruleScenarioInputsOpts"
                                                        ></text-input>
                                                    </div>

                                                    <div class="row-item-margins" style="flex: 0 0 200px">
                                                        <!--<md-input-container style="width: 80%"
                                                                            aria-label="select with filter">

                                                            <label for="">Transaction type</label>
                                                            <md-select
                                                                    ng-model="vm.errorRuleScenario.transaction_type"
                                                                    ng-change="vm.onTransactionTypeChange($event, vm.errorRuleScenario)"
                                                                    md-container-class="common-select-container"
                                                                    md-on-close="searchTerm = ''"
                                                                    style="margin: 0;">

                                                                <md-select-header>
                                                                    <input data-ng-model="searchTerm"
                                                                           type="search"
                                                                           placeholder="Search for a ..."
                                                                           class="md-text md-select-search-pattern select-input-filter"
                                                                           ng-keydown="$event.stopPropagation()">
                                                                </md-select-header>

                                                                <div class="select-options-holder">

                                                                    <md-option
                                                                            data-ng-repeat="transactionType in vm.transactionTypes | filter: {name: searchTerm}"
                                                                            ng-value="transactionType.user_code"
                                                                    >
                                                                        {{transactionType.name}}
                                                                        ({{transactionType.user_code}})
                                                                    </md-option>

                                                                </div>

                                                            </md-select>
                                                        </md-input-container>-->
                                                        <dropdown-select data-label="Transaction type"
                                                                         data-model="vm.errorRuleScenario.transaction_type"
                                                                         data-menu-options="vm.transactionTypesOpts"
                                                                         data-on-change-callback="vm.onTransactionTypeChange(changedValue, vm.errorRuleScenario)"></dropdown-select>
                                                    </div>

                                                    <div class="flex-row flex-i-center p-l-4">

                                                        <md-button class="outline-button row-item-margins action-btn"
                                                                   data-ng-disabled="!vm.errorRuleScenario.transaction_type"
                                                                   data-ng-click="vm.errorRuleScenario.showInputs = !vm.errorRuleScenario.showInputs">
                                                            <span class="material-icons">view_list</span>

                                                            <md-tooltip class="tooltip_1"
                                                                        data-md-direction="top">
                                                                <span>{{vm.errorRuleScenario.showInputs ? 'Hide' : 'Show'}} Inputs</span>
                                                            </md-tooltip>
                                                        </md-button>

                                                        <md-button class="outline-button row-item-margins action-btn"
                                                                   data-ng-disabled="!vm.errorRuleScenario.transaction_type"
                                                                   data-ng-click="vm.editTransactionType(vm.errorRuleScenario.transaction_type_object.id, $event)">
                                                            <span class="material-icons">mode_edit</span>
                                                            <md-tooltip class="tooltip_1"
                                                                        data-md-direction="top">Edit transaction type</md-tooltip>
                                                        </md-button>

                                                    </div>
                                                </div>

                                                <div data-ng-if="vm.errorRuleScenario.error_message"
                                                     class="row-error">
                                                    <span class="error-color">{{vm.errorRuleScenario.error_message}}</span>
                                                </div>

                                                <div data-ng-if="vm.errorRuleScenario.showInputs"
                                                     class="transaction-import-scheme-v2-scenario-inputs-holder">

                                                    <div data-ng-if="vm.errorRuleScenario.frontOptions.processing">
                                                        <div layout="row" layout-sm="column"
                                                             layout-align="space-around" class="m-16">
                                                            <progress-circular diameter="30"></progress-circular>
                                                        </div>
                                                    </div>

                                                    <div data-ng-if="!vm.errorRuleScenario.frontOptions.processing">
                                                        <table class="transaction-import-scheme-v2-scenario-inputs-table">
                                                            <tr data-ng-repeat="input_item in vm.errorRuleScenario.frontOptions.transactionTypeInputs"
                                                                class="transaction-import-scheme-v2-scenario-inputs">
                                                                <td>
                                                                    <div class="transaction-import-scheme-v2-scenario-inputs-input-name">
                                                                        <span data-ng-bind="input_item.verbose_name"></span>
                                                                        <div style="white-space: nowrap;">Input:
                                                                            <b><span
                                                                                    data-ng-bind="input_item.name"></span></b>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div layout="row"
                                                                         class="transaction-import-scheme-v2-scenario-inputs-input-expressio">
                                                                        <div>
                                                                            <md-input-container>
                                                                                <label for=""
                                                                                       data-ng-bind="vm.bindType(input_item)"></label>
                                                                                <input type="text"
                                                                                       data-ng-model="input_item.expression">
                                                                            </md-input-container>
                                                                        </div>
                                                                        <div>
                                                                            <expression-editor-button
                                                                                    data-item="input_item.expression"
                                                                                    data-data="{groups: [vm.inputsGroup], functions: [vm.inputsFunctions]}"></expression-editor-button>
                                                                        </div>


                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div data-ng-if="input_item.dryRunResult">

                                                                        <span class="dry-run-result-value">{{input_item.dryRunResult}}</span>

                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </div>

                                            </div>


                                        </md-card-content>
                                    </md-card>
                                </div>
                            </div>

                        </md-tab-body>

                    </md-tab>


                </md-tabs>


            </div>
            <div data-ng-if="!vm.checkReadyStatus()">
                <div layout="row" layout-sm="column" layout-align="space-around" class="m-large">
                    <progress-circular diameter="100"></progress-circular>
                </div>
            </div>
        </md-content>
    </md-dialog-content>

    <md-dialog-actions layout="row" class="position-relative">
        <!--<md-button class="outline-button"
                   data-ng-click="vm.editAsJson($event)">
            Edit as JSON
        </md-button>-->
        <md-button class="outline-button" ng-click="vm.makeCopy($event)" data-ng-if="vm.scheme.id"
                   data-ng-class="{'disabled-btn': vm.processing}">
            Make a copy
        </md-button>
        <md-button class="link-button" ng-click="vm.cancel()">
            Cancel
        </md-button>
        <md-button class="md-raised md-primary m-r-20" ng-click="vm.agree()"
                   data-ng-disabled="vm.processing">
            <span data-ng-if="vm.scheme.id">Save</span>
            <span data-ng-if="!vm.scheme.id">Create</span>
        </md-button>
    </md-dialog-actions>
</md-dialog>